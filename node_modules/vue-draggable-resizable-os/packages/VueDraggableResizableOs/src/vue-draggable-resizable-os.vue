<template>
  <vue-draggable-resizable
      :min-width="minWidth"
      :grid="grid"
      :min-height="minHeight"
      :x="x"
      :y="y"
      :w="width"
      :h="height"
      :parent="parent"
      :draggable="cDrag && !full"
      :resizable="cResize && !full"
      :exchangeModule="exchangeModule"
      @resizing="onResizing"
      @resizestop="onResizestop"
      @dragging="onDraging"
      @dragstop="onDragstop"
      @deactivated="onDeactivated"
      @activated="onActivated"
      :class-name="full?'draggable-resizeable-os fullscreen':'draggable-resizeable-os'"
      class-name-active="active"
      v-if="show"
      ref="ref"
  >
    <div :style="exchangeStyle">
      <div :class="'draggable-resizeable-os-container'+ (showHeader?' show-header':'')">
        <div class="draggable-resizeable-os-header"
             :style="renderStyle">
          <div class="header-title">
            <span>{{ title }}</span>
          </div>
          <div class="header-control">
            <span class="btn resize-max" v-show="full" @click="onFullscreen(false)"></span>
            <span class="btn max" v-show="!full"  @click="onFullscreen(true)"></span>
            <span class="btn close" @click="onClose"></span>
          </div>
        </div>
        <div class="draggable-resizeable-os-body">
          <div class="draggable-resizeable-os-body-slot">
            <slot></slot>
          </div>
        </div>
      </div>
    </div>

  </vue-draggable-resizable>
</template>

<script>
import VueDraggableResizable from '../VueDraggableResizable/components/vue-draggable-resizable'
import '../VueDraggableResizable/components/vue-draggable-resizable.css'

export default {
  name: "VueDraggableResizableOs",
  components:{
    VueDraggableResizable
  },
  props:{
    x: {
      type: Number,
      default: 0,
    },
    y: {
      type: Number,
      default: 0,
    },
    width: {
      type: [Number, String],
      default: 'auto',
      validator: (val) => {
        if (typeof val === 'number') {
          return val > 0
        }
        return val === 'auto'
      }
    },
    height: {
      type: [Number, String],
      default: 'auto',
      validator: (val) => {
        if (typeof val === 'number') {
          return val > 0
        }
        return val === 'auto'
      }
    },
    parent: {
      type: Boolean,
      default: false
    },
    title: {
      type: String,
      default: '我的拖拽组件'
    },
    minWidth: {
      type: Number,
      default: 100
    },
    minHeight: {
      type: Number,
      default: 100
    },
    showHeader: {
      type: Boolean,
      default: true
    },
    grid: {
      type: Array,
      default: () => [1, 1]
    },
    canDrag: {
      type: Boolean,
      default: true
    },
    canResize: {
      type: Boolean,
      default: true
    },
    fullscreen: {
      type: Boolean,
      default: false
    },
    headerColor: {
      type: String,
      default: '#ffffff'
    },
    headerBg:{
      type: String,
      default: '#20a0ff'
    },
    exchangeBorder:{
      type: String,
      default: '2px dashed red'
    },
    exchange:{
      type: Boolean,
      default: false
    }

  },
  computed:{
    renderStyle(){
      return {
        backgroundColor: this.headerBg,
        color: this.headerColor
      }
    },
    exchangeStyle(){
      return {
        border: this.isExchange ? this.exchangeBorder : null,
        height: '100%',
        boxSizing: 'border-box'
      }
    }
  },
  watch:{
    exchangeModule(newVal,oldVal){
      this.$refs.ref.setItem('exchange',newVal)
    },
  },
  data(){
    return {
      show: true,
      full: this.fullscreen,
      cDrag: this.canDrag,
      cResize: this.canResize,
      Os:{
        x: this.x,
        y: this.y,
        width: this.width,
        height: this.height
      },
      oldHtmlOverflow: null,
      scrollEvent: null,
      exchangeModule: this.exchange,
      isExchange: false
    }
  },
  methods:{
    onResizing(x, y, width, height){
      this.$emit('resizestart',x,y,width,height);
    },
    onResizestop(x,y,width,height){
      this.Os = {x,y,width,height};
      this.$emit('resizestop',x,y,width,height);
    },
    onDraging(x, y,e){
      this.$emit('dragstart',x,y,e);
    },
    onDragstop(x,y,old){
      this.Os.x = x;
      this.Os.y = y;
      this.$emit('dragstop',x,y,old);
    },
    onFullscreen(type){
      this.full = type;
      type ? this.stop() : this.move();
      this.$emit( type ? 'fullscreen' : 'resizescreen' );
    },
    onClose(){
      this.show = false;
      this.$emit('close',this);
    },
    onDeactivated(){
      this.$emit('outClick',this);//点击组件外执行
    },
    onActivated(){
      this.$emit('inClick',this);//点击组件内执行
    },
    toggleEditing(type) {
      this.cResize = type;
      this.cDrag = type;
    },
    getValue() {
      const value = JSON.parse(JSON.stringify(this.$props));
      const { x,y,width,height } = this.Os;
      value.x = x;
      value.y = y;
      value.width = width;
      value.height = height;
      return value;
    },
    //禁止滚动
    stop(){
      this.scrollEvent = function(e){e.preventDefault();};
      this.oldHtmlOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';
      document.addEventListener("touchmove",this.scrollEvent,false);//禁止页面滑动
    },
    /***取消滑动限制***/
    move(){
      document.body.style.overflow = this.oldHtmlOverflow;
      document.removeEventListener("touchmove",this.scrollEvent,false);
    },
    setItem(itemName,itemVal){
      this.$refs.ref.setItem(itemName,itemVal)
    },
    setTargetItem(itemName,itemVal){
      this[itemName] = itemVal;
    }
  }
}
</script>

<style lang="scss" scoped>
.draggable-resizeable-os{
  //border: 1px solid lightgray;
  z-index: 10 !important;
  position: absolute;
  background: #ffffff;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  &.active{
    z-index: 11 !important;
  }
  &.fullscreen{
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    width: 100% !important;
    height: 100% !important;
    transform: translate(0,0) !important;
    z-index: 1500 !important;
  }
  .draggable-resizeable-os-container{
    position: relative;
    width: 100%;
    height: 100%;
    .draggable-resizeable-os-header{
      display: none;
      -webkit-box-pack: justify;
      -ms-flex-pack: justify;
      justify-content: space-between;
      align-items: center;
      height: 30px;
      width: 100%;
      //line-height: 30px;
      //color: #ffffff;
      //background-color: #ffffff;
      position: absolute;
      top: 0;
      z-index: 100;
      overflow: hidden;
      //&.primary{
      //  background: #20a0ff;
      //}
      //&.info{
      //  background-color: #909399;
      //}
      //&.success{
      //  background-color: #67c23a;
      //}
      //&.warning{
      //  background-color: #e6a23c;
      //}
      //&.danger{
      //  background-color: #f56c6c;
      //}
      .header-title{
        margin-left: 10px;
      }
      .header-control{
        margin-right: 5px;
        .btn{
          display: inline-block;
          width: 20px;
          height: 20px;
          margin: 5px 5px 0 0;
          border-radius: 3px;
          position: relative;
          cursor: pointer;
          line-height: 30px;
          &.max{
            background: gray;
            &::before{
              box-sizing: border-box;
              content: "";
              display: block;
              position: absolute;
              height: 12px;
              width: 12px;
              left: 4px;
              top: 4px;
              border: 1px solid #fff;
              border-top-width: 2px;
            }
          }
          &.resize-max{
            background: gray;
            &::before,&::after{
              box-sizing: border-box;
              content: "";
              display: block;
              position: absolute;
              height: 8px;
              width: 8px;
              border: 1px solid #fff;
              border-top-width: 2px;
              top: 3px;
              left: 8px;
            }
            &::after{
              top: 8px;
              left: 3px;
            }
          }

          &.close{
            background: #d26262;
            &::before,&::after{
              content: "";
              display: block;
              position: absolute;
              height: 2px;
              width: 14px;
              left: 3px;
              top: 9px;
              background: #fff;
              transform: rotate(45deg);
              -webkit-transform: rotate(45deg);
              -moz-transform: rotate(45deg);
            }
            &::after{
              transform: rotate(-45deg);
              -webkit-transform: rotate(-45deg);
              -moz-transform: rotate(-45deg);
            }
          }
        }
      }
    }
    &.show-header{
      .draggable-resizeable-os-header{
        display: flex;
      }
      .draggable-resizeable-os-body{
        padding-top: 30px;
      }
    }
    .draggable-resizeable-os-body{
      position: relative;
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      .draggable-resizeable-os-body-slot{
        height: 100%;
        overflow: auto;
      }
    }
  }
}



</style>
