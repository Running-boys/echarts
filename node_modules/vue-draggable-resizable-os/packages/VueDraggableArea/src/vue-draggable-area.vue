<!--
 * @Author: your name
 * @Date: 2021-08-20 14:22:49
 * @LastEditTime: 2021-08-20 14:33:24
 * @LastEditors: Please set LastEditors
 * @Description: In User Settings Edit
 * @FilePath: \vue-draggable-resizable-os\packages\VueDraggableArea\src\vue-draggable-area.vue
-->
<template>
    <div class="vue-draggable-area" :style="areaStyle" ref="vue-draggable-area">
      <VueDraggableResizableOs
          v-for="(item,index) in list"
          :ref="item.component+'parent'+item.id"
          :key="index+'index'+item.id"
          :width="item.width"
          :height="item.height"
          :x="item.x"
          :y="item.y"
          :title="item.title"
          :show-header="item.showHeader"
          :header-color="item.headerColor"
          :header-bg="item.headerBg"
          :exchangeBorder="item.exchangeBorder"

          :exchange="exchangeModule"
          :can-drag="canEdit"
          :can-resize="canEdit"
          @resizestop="resizestop(item.id,...arguments)"
          @dragstop="dragstop(item.id,...arguments)"
          @dragstart="dragstart(item.id,...arguments)"
          @close="close(item.id)"
          @fullscreen="fullscreen(item.id)"
          @resizescreen="resizescreen(item.id)"
      >
        <component :is="item.component" :ref="item.component+'child'+item.id" @emitEvents="emitToEvents(item,...arguments)"></component>
      </VueDraggableResizableOs>
      <slot></slot>
    </div>
</template>


<script>
import VueDraggableResizableOs from '../../VueDraggableResizableOs/src/vue-draggable-resizable-os'
import ResizeObserver from '../uitls/resize-observer-polyfill';
import { isFunction } from "../../VueDraggableResizableOs/VueDraggableResizable/utils/fns";

export default {
    name: 'VueDraggableArea',
    components:{
        VueDraggableResizableOs
    },
    props:{
      data: {
        type: Array,
        default: ()=>[]
      },
      gridBg:{
        type: Array,
        default: ()=>["rgba(255,255,255,0.2)",30, "rgba(36,41,46,1)"]
      },
      model:{
        type: Boolean,
        default: false  //false自由模式 true 交换模式
      },
      canEdit:{
        type: Boolean,
        default: true //是否可编辑
      }

    },
    computed:{
      areaStyle(){
        return {
          background: 'linear-gradient(-90deg,'+this.gridBgStyle[0] +' 2px, transparent 2px) 0% 0% / ' + this.gridBgStyle[1]+'px ' + this.gridBgStyle[1]+'px,'+
          'linear-gradient('+this.gridBgStyle[0] +' 2px, transparent 2px) 0% 0% / ' + this.gridBgStyle[1]+'px ' + this.gridBgStyle[1]+'px, '+ this.gridBgStyle[2]
        }
      }
    },
    watch:{
      elWidth(newVal,oldVal){
        if(oldVal){
          this.list.forEach(item=>{
            const newW = this.getNewPx(item.width,oldVal,newVal);
            const newX = this.getNewPx(item.x,oldVal,newVal);
            item.width = newW;
            item.x = newX;
            // this.$nextTick(()=>{
              this.$refs[item.component+'parent'+item.id][0].setItem('width',newW);
              this.$refs[item.component+'parent'+item.id][0].setItem('left',newX);
            // })
          })
        }
      },
      elHeight(newVal,oldVal){
        if(oldVal){
          this.list.forEach(item=>{
            const newH = this.getNewPx(item.height,oldVal,newVal);
            const newY = this.getNewPx(item.y,oldVal,newVal);
            item.height = newH;
            item.y = newY;
            // this.$nextTick(()=>{
              this.$refs[item.component+'parent'+item.id][0].setItem('height',newH);
              this.$refs[item.component+'parent'+item.id][0].setItem('top',newY);
            // })
          })
        }
      },
      gridBg:{
        handler(newVal,oldVal) {
          this.gridBgStyle = newVal;
        },
        deep: true
      },
      canEdit(newVal){
        this.list.forEach(item=>{
          this.$refs[item.component+'parent'+item.id][0].toggleEditing(newVal);
        })
      },
      model(newVal,oldVal){
        this.exchangeModule = newVal;
      },
      exchangeModule(newVal,oldVal){
        this.list.forEach(item=>{
          this.$refs[item.component+'parent'+item.id][0].setTargetItem('exchangeModule',newVal);
        })
      }
    },
    data(){
        return {
            list: [],
            elWidth: null,
            elHeight: null,
            Observer: null,
            exchangeTarget: null,
            exchangeModule: this.model, //false自由模式 true 交换模式
            gridBgStyle: this.gridBg,
            show: false
        }
    },
    mounted() {
      this.initList(this.data);
      this.addEventBox();
      this.elWidth = this.getParentSize()[0];
      this.elHeight = this.getParentSize()[1];
    },
    destroyed() {
      this.removeEventBox();
    },
    methods:{
      initList(list){
          list.forEach(item=>{
            item.width = item.width * this.getParentSize()[0];
            item.height = item.height * this.getParentSize()[1];
            item.x = item.x * this.getParentSize()[0];
            item.y = item.y * this.getParentSize()[1];
          })
          this.list = list;
      },
      addEventBox(){
        this.Observer = new ResizeObserver((entries, observer) => {
          this.elWidth = this.getParentSize()[0];
          this.elHeight = this.getParentSize()[1];
        });
        this.Observer.observe(this.$el);
      },
      removeEventBox(){
        this.Observer.unobserve(this.$el);
      },
      getParentSize () {
        const style = window.getComputedStyle(this.$el, null)
        return [
          parseInt(style.getPropertyValue('width'), 10),
          parseInt(style.getPropertyValue('height'), 10)
        ]
      },
      getNewPx(oldPx,oldParent,newParent){
        return oldPx / oldParent * newParent;
      },
      getValue(itemName){
        if(!itemName){
          const value = JSON.parse(JSON.stringify(this.list));
          const [parentW,parentH] = this.getParentSize();
          value.forEach(item=>{
            item.x = item.x / parentW;
            item.y = item.y / parentH;
            item.width = item.width / parentW;
            item.height = item.height / parentH;
          })
          return {
            data: value,
            gridBg: this.gridBgStyle,
            model: this.exchangeModule,
            canEdit: this.canEdit
          };
        }else{
          return  this[itemName];
        }
      },
      /*** 检测鼠标是否在拖拽组件内部 ***/
      checkInbox(e,item){
        const ePageX = e.layerX;
        const ePageY = e.layerY;
        if(ePageX > item.x && ePageX < item.x+item.width && ePageY > item.y && ePageY < item.y+item.height){
          return true;
        }else {
          return  false;
        }
      },
      resizestop(id,x,y,width,height){
        const obj = this.list.find(item=>item.id===id)
        if(obj){
          obj.x = x;
          obj.y = y;
          obj.width = width;
          obj.height = height;
        }
        this.$emit('resizestop',id,this.getValue());
      },
      dragstart(id,x,y,e){
        if(this.exchangeModule){  //设置样式
          const targetList = [];
          this.list.find(item=>{
              if(this.checkInbox(e,item) && item.id !== id){
                this.$refs[item.component+'parent'+item.id][0].setTargetItem('isExchange',true)
                targetList.push(item);
                if(targetList.length>1){
                  this.$refs[targetList[0].component+'parent'+targetList[0].id][0].setTargetItem('isExchange',false)
                }
              }else {
                this.$refs[item.component+'parent'+item.id][0].setTargetItem('isExchange',false)
              }
          })
          this.exchangeTarget = targetList.pop();
        }
      },
      dragstop(id,x,y,old){
        const obj = this.list.find(item=>item.id===id)
        if(obj){
          obj.x = x;
          obj.y = y;
        }
        if(this.exchangeModule){//如果是交换模式
          if(this.exchangeTarget){
            this.$refs[this.exchangeTarget.component+'parent'+this.exchangeTarget.id][0].setItem('width',obj.width);
            this.$refs[this.exchangeTarget.component+'parent'+this.exchangeTarget.id][0].setItem('height',obj.height);
            this.$refs[this.exchangeTarget.component+'parent'+this.exchangeTarget.id][0].setItem('left',x);
            this.$refs[this.exchangeTarget.component+'parent'+this.exchangeTarget.id][0].setItem('top',y);
            const temp = JSON.parse(JSON.stringify(this.exchangeTarget));
            this.exchangeTarget.x = x;
            this.exchangeTarget.y = y;
            this.exchangeTarget.width = obj.width;
            this.exchangeTarget.height = obj.height;


            this.$refs[obj.component+'parent'+obj.id][0].setItem('width',temp.width);
            this.$refs[obj.component+'parent'+obj.id][0].setItem('height',temp.height);
            this.$refs[obj.component+'parent'+obj.id][0].setItem('left',temp.x);
            this.$refs[obj.component+'parent'+obj.id][0].setItem('top',temp.y);
            obj.x = temp.x;
            obj.y = temp.y;
            obj.width = temp.width;
            obj.height = temp.height;

            this.$refs[this.exchangeTarget.component+'parent'+this.exchangeTarget.id][0].setTargetItem('isExchange',false);
            this.exchangeTarget = null;

          }else{
            obj.x = old.oldLeft;
            obj.y = old.oldTop;
            // obj.width = old.oldWidth;
            // obj.height = old.oldHeight;
          }
        }
        this.$emit('dragstop',id,this.getValue());
      },
      close(id){
        this.list = this.list.filter(item=>item.id!==id);
        this.$emit('close',id,this.getValue());
      },
      fullscreen(id){
        this.$emit('fullscreen',id);
      },
      resizescreen(id){
        this.$emit('resizescreen',id);
      },
      /*** 切换模式自由模式 true  组件对调模式 false ***/
      toggleModule(type) {
        this.exchangeModule = type;
        this.$emit('modelChange',type);
      },
      /*** 触发给每个子组件组件事件 并传递参数 ***/
      emitToEvents(from,eName,eParams){
        this.list.forEach(item=>{
          const el = this.$refs[item.component+'child'+item.id][0];
          isFunction(el.emitEvent) && el.emitEvent(from,eName,eParams);
        })
      }
    }
}
</script>
<style>
.vue-draggable-area{
  width: 100%;
  height: 100%;
  position: relative;
  overflow: auto;
  box-sizing: border-box;
}
</style>
